(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Velocity = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict";module.exports=function(t){for(var r=0,o=Object.getOwnPropertyNames(t.constructor.prototype);r<o.length;r+=1){var e=o[r],n=t[e];"constructor"!==e&&"function"==typeof n&&(t[e]=n.bind(t))}return t};
},{}],2:[function(require,module,exports){
"use strict";var Windy=require("./windy"),autoBind=require("./autobind"),VelocityLayer=function(t){this.options=Object.assign({displayValues:!0,displayOptions:{velocityType:"Velocity",position:"bottomleft",emptyString:"No velocity data"},maxVelocity:10,colorScale:null,data:null,canvas:null},t),this._map=this.options.map,this._windy=null,this._context=null,this._timer=0,this.isDrag=!1,this.currentPos=null,autoBind(this)};VelocityLayer.initVelocityComponent=function(t){var i=t.getCanvasContainer(),e=document.createElement("canvas");return e.style.position="absolute",e.style.left="0",e.style.right="0",e.style.top="0",e.style.bottom="0",e.style["pointer-events"]="none",e.setAttribute("id","windcanvas"),e.setAttribute("width",t.getCanvas().style.width),e.setAttribute("height",t.getCanvas().style.height),i.appendChild(e),e},VelocityLayer.prototype.remove=function(){this._destroyWind()},VelocityLayer.prototype.setData=function(t){this.options.data=t,this._windy&&(this._windy.setData(t),this._clearAndRestart())},VelocityLayer.prototype.drawLayer=function(){var t=this;if(t.options.canvas.setAttribute("width",parseInt(t._map.getCanvas().style.width)),t.options.canvas.setAttribute("height",parseInt(t._map.getCanvas().style.height)),!this._windy)return void this._initWindy(this);this.options.data&&(this._timer&&clearTimeout(t._timer),this._timer=setTimeout(function(){t._startWindy()},20))},VelocityLayer.prototype._startWindy=function(){var t=this._map.getBounds(),i=this._map.getCanvas(),e=window.devicePixelRatio;this._windy.start([[0,0],[i.width/e,i.height/e]],i.width/e,i.height/e,[[t._sw.lng,t._sw.lat],[t._ne.lng,t._ne.lat]])},VelocityLayer.prototype._initWindy=function(t){var i=t.options;this._windy=new Windy(i),this._context=this.options.canvas.getContext("2d"),this.drawLayer(),this._map.on("movestart",this.moveStart),this._map.on("move",this.move),this._map.on("moveend",this.moveEnd),this._map.on("resize",this.resize),this._initMouseHandler()},VelocityLayer.prototype._initMouseHandler=function(){},VelocityLayer.prototype._clearAndRestart=function(){this._context&&this._context.clearRect(0,0,3e3,3e3),this._windy&&this._startWindy()},VelocityLayer.prototype._clearWind=function(){this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3)},VelocityLayer.prototype.stop=function(){this._windy.stop()},VelocityLayer.prototype.start=function(){this._startWindy()},VelocityLayer.prototype.destory=function(){this._destroyWind()},VelocityLayer.prototype._destroyWind=function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._map.off("movestart",this.moveStart),this._map.off("move",this.move),this._map.off("moveend",this.moveEnd),this._map.off("resize",this.resize),this._windy=null},VelocityLayer.prototype.move=function(t){if(this.isDrag){var i=[t.originalEvent.x,t.originalEvent.y],e=i[0]-this.currentPos[0],n=i[1]-this.currentPos[1];this.options.canvas.style.transform="translate3d("+e+"px, "+n+"px, 0px)"}},VelocityLayer.prototype.moveEnd=function(){this.isDrag=!1,this._clearAndRestart(),this.options.canvas.style.transition="",this.options.canvas.style.transform="translate3d(0px, 0px, 0px)"},VelocityLayer.prototype.resize=function(){this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._canvasWidth=parseInt(this._map.getCanvas().style.width),this._canvasHeight=parseInt(this._map.getCanvas().style.height),this.options.canvas.setAttribute("width",this._canvasWidth),this.options.canvas.setAttribute("height",this._canvasHeight)},VelocityLayer.prototype.moveStart=function(t){if(t.originalEvent&&"mousemove"===t.originalEvent.type&&(this.isDrag=!0,this.currentPos=[t.originalEvent.x,t.originalEvent.y]),t.originalEvent&&"keydown"===t.originalEvent.type){var i=0,e=0;switch(t.originalEvent.keyCode){case 37:t.originalEvent.shiftKey||(t.originalEvent.preventDefault(),i=100);break;case 39:t.originalEvent.shiftKey||(t.originalEvent.preventDefault(),i=-100);break;case 38:t.originalEvent.shiftKey||(t.originalEvent.preventDefault(),e=100);break;case 40:t.originalEvent.shiftKey||(t.originalEvent.preventDefault(),e=-100);break;default:return}this.options.canvas.style.transition="transform 0.5s ease",this.options.canvas.style.transform="translate3d("+i+"px, "+e+"px, 0px)"}},module.exports=VelocityLayer;
},{"./autobind":1,"./windy":3}],3:[function(require,module,exports){
"use strict";var Windy=function(t){var n,a,e,r,o,i,u,h,l,c,f=t.minVelocity||0,d=t.maxVelocity||10,s=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),M=t.particleAge||90,g=t.lineWidth||1,v=t.particleMultiplier||1/300,m=Math.pow(window.devicePixelRatio,1/3)||1.6,w=t.frameRate||15,p=1e3/w,b=t.uLineRatio||1,x=t.vLineRatio||1,y=["rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255)","rgb(255,255, 255","rgb(255,255, 255)","rgb(255,255, 255)"],P=t.colorScale||y,A=[NaN,NaN,null],F=t.data,I=function(t){F=t},D=function(t,n,a,e,r,o){var i=1-t,u=1-n,h=i*u,l=t*u,c=i*n,f=t*n,d=a[0]*h+e[0]*l+r[0]*c+o[0]*f,s=a[1]*h+e[1]*l+r[1]*c+o[1]*f;return d*=b,s*=x,[-d,-s,Math.sqrt(d*d+s*s)]},R=function(t,n){var a=t.data,e=n.data;return{header:t.header,data:function(t){return[a[t],e[t]]},interpolate:D}},T=function(t){var n=null,a=null,e=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":n=t;break;case"1,3":case"2,3":a=t;break;default:e=t}}),R(n,a)},k=function(t,c){n=T(t);var f=n.header;r=f.lo1,o=f.la1,i=f.dx,u=f.dy,h=f.nx,l=f.ny,e=new Date(f.refTime),e.setHours(e.getHours()+f.forecastTime),a=[];for(var d=0,s=Math.floor(h*i)>=360,M=0;M<l;M++){for(var g=[],v=0;v<h;v++,d++)g[v]=n.data(d);s&&g.push(g[0]),a[M]=g}c({date:e,interpolate:E})},E=function(t,e){if(!a)return null;var h,l=C(t-r,360)/i,c=(o-e)/u,f=Math.floor(l),d=f+1,s=Math.floor(c),M=s+1;if(h=a[s]){var g=h[f],v=h[d];if(N(g)&&N(v)&&(h=a[M])){var m=h[f],w=h[d];if(N(m)&&N(w))return n.interpolate(l-f,c-s,g,v,m,w)}}return null},N=function(t){return null!==t&&void 0!==t},C=function(t,n){return t-n*Math.floor(t/n)},S=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},W=function(t,n,a,e,r,o,i,u){var h=i[0]*o,l=i[1]*o,c=z(t,n,a,e,r,u);return i[0]=c[0]*h+c[2]*l,i[1]=c[1]*h+c[3]*l,i},z=function(t,n,a,e,r,o){var i=2*Math.PI,u=Math.pow(10,-5.2),h=n<0?u:-u,l=a<0?u:-u,c=B(a,n+h,o),f=B(a+l,n,o),d=Math.cos(a/360*i);return[(c[0]-e)/h/d,(c[1]-r)/h/d,(f[0]-e)/l,(f[1]-r)/l]},q=function(t,n,a){function e(n,a){var e=t[Math.round(n)];return e&&e[Math.round(a)]||A}e.release=function(){t=[]},e.randomize=function(t){var a,r,o=0;do{a=Math.round(Math.floor(Math.random()*n.width)+n.x),r=Math.round(Math.floor(Math.random()*n.height)+n.y)}while(null===e(a,r)[2]&&o++<30);return t.x=a,t.y=r,t},a(n,e)},H=function(t,n,a){var e=t[0],r=t[1],o=Math.round(e[0]),i=Math.max(Math.floor(e[1],0),0);Math.min(Math.ceil(r[0],n),n-1);return{x:o,y:i,xMax:n,yMax:Math.min(Math.ceil(r[1],a),a-1),width:n,height:a}},L=function(t){return t/180*Math.PI},O=function(t){return t/(Math.PI/180)},V=function(t,n,a){var e=a.east-a.west,r=a.width/O(e)*360/(2*Math.PI),o=r/2*Math.log((1+Math.sin(a.south))/(1-Math.sin(a.south))),i=a.height+o,u=(i-n)/r,h=180/Math.PI*(2*Math.atan(Math.exp(u))-Math.PI/2);return[O(a.west)+t/a.width*O(e),h]},j=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},B=function(t,n,a){var e=j(a.south),r=j(a.north),o=a.width/(a.east-a.west),i=a.height/(r-e),u=j(L(t)),h=(L(n)-a.west)*o,u=(r-u)*i;return[h,u]},G=function(t,n,a,e){function r(e){for(var r=[],i=n.y;i<=n.yMax;i+=2){var l=V(e,i,a);if(l){var c=l[0],f=l[1];if(isFinite(c)){var d=t.interpolate(c,f);d&&(d=W(o,c,f,e,i,u,d,a),r[i+1]=r[i]=d)}}}h[e+1]=h[e]=r}var o={},i=(a.south-a.north)*(a.west-a.east),u=s*Math.pow(i,.4),h=[],l=n.x;!function t(){for(var a=Date.now();l<n.width;)if(r(l),l+=2,Date.now()-a>1e3)return void setTimeout(t,25);q(h,n,e)}()},J=function(n,a){function e(){i.forEach(function(t){t.length=0}),h.forEach(function(t){t.age>M&&(a.randomize(t).age=0);var n=t.x,e=t.y,r=a(n,e),u=r[2];if(null===u)t.age=M;else{var h=n+r[0],l=e+r[1];null!==a(h,l)[2]?(t.xt=h,t.yt=l,i[o.indexFor(u)].push(t)):(t.x=h,t.y=l)}t.age+=1})}function r(){s.globalCompositeOperation="destination-in",s.fillRect(n.x,n.y,n.width,n.height),s.globalCompositeOperation="lighter",s.globalAlpha=.9,i.forEach(function(t,n){t.length>0&&(s.beginPath(),s.strokeStyle=o[n],t.forEach(function(t){s.moveTo(t.x,t.y),s.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),s.stroke())})}var o=function(t,n){return P.indexFor=function(a){return Math.max(0,Math.min(P.length-1,Math.round((a-t)/(n-t)*(P.length-1))))},P}(f,d),i=o.map(function(){return[]}),u=Math.round(n.width*n.height*v);S()&&(u*=m);for(var h=[],l=0;l<u;l++)h.push(a.randomize({age:Math.floor(Math.random()*M)+0}));var s=t.canvas.getContext("2d");s.lineWidth=g,s.fillStyle="rgba(0, 0, 0, 0.97)",s.globalAlpha=.6;var w=Date.now();!function t(){c=requestAnimationFrame(t);var n=Date.now(),a=n-w;a>p&&(w=n-a%p,e(),r())}()},K=function(t,n,a,e){var r={south:L(e[0][1]),north:L(e[1][1]),east:L(e[1][0]),west:L(e[0][0]),width:n,height:a};Q(),k(F,function(e){G(e,H(t,n,a),r,function(t,n){U.field=n,J(t,n)})})},Q=function(){U.field&&U.field.release(),c&&cancelAnimationFrame(c)},U={params:t,start:K,stop:Q,createField:q,interpolatePoint:E,setData:I};return U};window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),module.exports=Windy;
},{}]},{},[2])(2)
});


//# sourceMappingURL=velocity.js.map